generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  schemas  = ["public", "private"]
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  SUPER_ADMIN // Manages all organizations (can also accept org registrations)
  ORG_ADMIN   // Manages a single organization (can also invite employees to their org)
  EMPLOYEE

  @@schema("public")
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY

  @@schema("public")
}

enum OrganizationStatus {
  PENDING   // Awaiting super admin approval
  ACTIVE    // Approved and operational
  REJECTED  // Denied by super admin
  SUSPENDED
  INACTIVE

  @@schema("public")
}

enum JobListingStatus {
  DRAFT
  ACTIVE
  PAUSED
  CLOSED
  ARCHIVED

  @@schema("public")
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  TEMPORARY
  INTERNSHIP

  @@schema("public")
}

enum CandidateSource {
  DIRECT_APPLICATION
  REFERRAL
  LINKEDIN
  JOB_BOARD
  RECRUITMENT_AGENCY
  CAREER_FAIR
  OTHER

  @@schema("public")
}

// ============================================================================
// EXISTING USER & ORGANIZATION MODELS
// ============================================================================

model User {
  id             String   @id @default(uuid())
  email          String   @unique
  isConfirmed    Boolean  @default(false)
  name           String
  role           UserRole @default(EMPLOYEE)
  organizationId String? // null for SUPER_ADMIN users
  departmentId   String? // null for SUPER_ADMIN and ORG_ADMIN users
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  password              Password?
  sessions              Session[]
  magicLinks            MagicLink[]
  profile               UserProfile?
  organization          Organization?        @relation("OrganizationMembers", fields: [organizationId], references: [id], onDelete: SetNull)
  department            Department?          @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  createdOrganization   Organization?        @relation("OrganizationCreator")
  approvedOrganizations Organization[]       @relation("OrganizationApprover")

  // Recruitment system relations
  createdJobListings    JobListing[]         @relation("JobListingCreator")
  jobListingMembers     JobListingMember[]
  boardActivities       BoardActivity[]
  candidateEvaluations  CandidateStageEvaluation[]

  @@index([organizationId])
  @@index([departmentId])
  @@schema("public")
}

model UserProfile {
  id          String    @id @default(uuid())
  userId      String    @unique
  dateOfBirth DateTime?
  gender      Gender?
  bio         String?   @db.Text
  phoneNumber String?

  // Address fields
  street1    String?
  street2    String?
  city       String?
  state      String?
  postalCode String?
  country    String?

  // Emergency contact
  emergencyContactName     String?
  emergencyContactPhone    String?
  emergencyContactRelation String?

  nationality       String?
  profilePictureUrl String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@schema("public")
}

model Password {
  id               String   @id @default(uuid())
  userId           String   @unique
  hashedPassword   String
  failedLoginCount Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@schema("private")
}

model Session {
  id        String   @id
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@schema("private")
}

model MagicLink {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique // securely generated random token, not a UUID
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@schema("private")
}

model Organization {
  id           String             @id @default(uuid())
  name         String
  status       OrganizationStatus @default(PENDING)
  description  String?            @db.Text
  website      String?
  createdById  String             @unique // User can only create one organization
  approvedById String?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  approvedAt   DateTime? // When super admin approved

  createdBy   User         @relation("OrganizationCreator", fields: [createdById], references: [id])
  approvedBy  User?        @relation("OrganizationApprover", fields: [approvedById], references: [id])
  branches    Branch[]
  users       User[]       @relation("OrganizationMembers")
  jobListings JobListing[]

  @@index([approvedById])
  @@index([status])
  @@schema("public")
}

model Branch {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  street1        String?
  street2        String?
  city           String?
  state          String?
  postalCode     String?
  country        String
  phoneNumber    String?
  email          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  departments  Department[]

  @@index([organizationId])
  @@schema("public")
}

model Department {
  id          String   @id @default(uuid())
  branchId    String
  name        String
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  branch      Branch       @relation(fields: [branchId], references: [id], onDelete: Cascade)
  users       User[]
  jobListings JobListing[]

  @@index([branchId])
  @@schema("public")
}

// ============================================================================
// RECRUITMENT/ATS MODELS
// ============================================================================

model JobListing {
  id                String            @id @default(uuid())
  organizationId    String
  departmentId      String
  officeId          String? // Optional: specific office/branch location
  title             String
  description       String            @db.Text
  status            JobListingStatus  @default(DRAFT)
  employmentType    EmploymentType
  openingsQuantity  Int               @default(1)
  isDeleted         Boolean           @default(false)
  closingDate       DateTime?
  createdById       String
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  publishedAt       DateTime?

  // Optional fields for job details
  salaryMin         Decimal?          @db.Decimal(12, 2)
  salaryMax         Decimal?          @db.Decimal(12, 2)
  salaryCurrency    String?           @default("USD")
  experienceYears   Int?
  educationLevel    String?
  skills            String[]          // Array of required skills
  benefits          String[]          // Array of benefits
  remoteOption      Boolean           @default(false)

  organization      Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department        Department                @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  createdBy         User                      @relation("JobListingCreator", fields: [createdById], references: [id])
  members           JobListingMember[]
  workflowStages    WorkflowStage[]
  stageCandidates   WorkflowStageCandidate[]

  @@index([organizationId])
  @@index([departmentId])
  @@index([status])
  @@index([createdById])
  @@index([closingDate])
  @@schema("public")
}

model JobListingMember {
  id           String   @id @default(uuid())
  jobListingId String
  memberId     String // References User
  // Can be substituted for roles table with static permissions per role
  // if we agree on role title enums
  canEdit      Boolean  @default(false)
  canEvaluate  Boolean  @default(true)
  addedAt      DateTime @default(now())

  jobListing JobListing @relation(fields: [jobListingId], references: [id], onDelete: Cascade)
  member     User       @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([jobListingId, memberId])
  @@index([jobListingId])
  @@index([memberId])
  @@schema("public")
}

model WorkflowStage {
  id           String            @id @default(uuid())
  jobListingId String
  title        String
  rank         Int // Order in the workflow (0, 1, 2, etc.)
  isLocked     Boolean           @default(false) // Prevent moving candidates out
  isDeleted         Boolean           @default(false)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  jobListing        JobListing               @relation(fields: [jobListingId], references: [id], onDelete: Cascade)
  candidates        WorkflowStageCandidate[]
  boardActivitiesFrom BoardActivity[]        @relation("FromStage")
  boardActivitiesTo   BoardActivity[]        @relation("ToStage")
  emailTemplates    EmailTemplateSetting[]

  @@unique([jobListingId, rank])
  @@index([jobListingId])
  @@schema("public")
}

model Candidate {
  id                String           @id @default(uuid())
  firstName         String
  lastName          String
  email             String
  phoneNumber       String?
  photoUrl          String?
  cvUrl             String
  attachmentUrl     String?
  source            CandidateSource  @default(DIRECT_APPLICATION)
  sourceDetails     String? // e.g., referrer name, agency name
  coverLetter       String?          @db.Text
  linkedinUrl       String?
  portfolioUrl      String?
  isDeleted         Boolean           @default(false)

  //  Optional if needed

  //  currentCompany    String?
  //  currentPosition   String?
  //  yearsOfExperience Int?
  //  expectedSalary    Decimal?         @db.Decimal(12, 2)
  //  noticePeriodDays  Int?

  tags              TagSetting[]     @relation("CandidateTags")
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  stagePlacements   WorkflowStageCandidate[]
  boardActivities   BoardActivity[]
  evaluations       CandidateStageEvaluation[]

  @@unique([email, phoneNumber]) // Prevent duplicate candidates
  @@index([email])
  @@index([lastName, firstName])
  @@schema("public")
}

model WorkflowStageCandidate {
  id              String    @id @default(uuid())
  candidateId     String
  jobListingId    String
  workflowStageId String
  isActive        Boolean   @default(true) // false when moved to another stage
  addedAt         DateTime  @default(now())
  movedAt         DateTime? // When moved to another stage
  notes           String?   @db.Text

  candidate     Candidate     @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  jobListing    JobListing    @relation(fields: [jobListingId], references: [id], onDelete: Cascade)
  workflowStage WorkflowStage @relation(fields: [workflowStageId], references: [id], onDelete: Cascade)
  evaluations   CandidateStageEvaluation[]

  @@unique([candidateId, jobListingId, workflowStageId, isActive]) // One active placement per stage
  @@index([candidateId])
  @@index([jobListingId])
  @@index([workflowStageId])
  @@index([isActive])
  @@schema("public")
}

model BoardActivity {
  id           String    @id @default(uuid())
  candidateId  String
  fromStageId  String?
  toStageId    String
  memberId     String // User who performed the action
  notes        String?   @db.Text
  activityType String    @default("MOVED") // MOVED, ADDED, REJECTED, etc.
  occurredAt   DateTime  @default(now())

  candidate Candidate      @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  fromStage WorkflowStage? @relation("FromStage", fields: [fromStageId], references: [id], onDelete: SetNull)
  toStage   WorkflowStage  @relation("ToStage", fields: [toStageId], references: [id], onDelete: Cascade)
  member    User           @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([candidateId])
  @@index([fromStageId])
  @@index([toStageId])
  @@index([memberId])
  @@index([occurredAt])
  @@schema("public")
}

model CandidateStageEvaluation {
  id                       String   @id @default(uuid())
  workflowStageCandidateId String
  memberId                 String // User who evaluated
  rating                   Int? // e.g., 1-5 scale
  feedback                 String?  @db.Text
  strengths                String?  @db.Text
  weaknesses               String?  @db.Text
  recommendation           String? // e.g., "MOVE_FORWARD", "REJECT", "HOLD"
  evaluatedAt              DateTime @default(now())
  updatedAt                DateTime @updatedAt

  stageCandidate WorkflowStageCandidate @relation(fields: [workflowStageCandidateId], references: [id], onDelete: Cascade)
  evaluator      User                   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([workflowStageCandidateId])
  @@index([memberId])
  @@schema("public")
}

model TagSetting {
  id          String      @id @default(uuid())
  name        String      @unique
  color       String? // Hex color code for UI display
  description String?
  createdAt   DateTime    @default(now())

  candidates  Candidate[] @relation("CandidateTags")

  @@schema("public")
}

model EmailTemplateType {
  id          String   @id @default(uuid())
  title       String   @unique
  description String?  @db.Text
  createdAt   DateTime @default(now())

  settings EmailTemplateSetting[]

  @@schema("public")
}

model EmailTemplateSetting {
  id                 String   @id @default(uuid())
  workflowStageId    String
  emailTemplateTypeId String
  subject            String
  body               String   @db.Text
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  workflowStage     WorkflowStage     @relation(fields: [workflowStageId], references: [id], onDelete: Cascade)
  emailTemplateType EmailTemplateType @relation(fields: [emailTemplateTypeId], references: [id], onDelete: Cascade)

  @@unique([workflowStageId, emailTemplateTypeId])
  @@index([workflowStageId])
  @@index([emailTemplateTypeId])
  @@schema("public")
}

// ============================================================================
// OPTIONAL: Interview Scheduling (Future Enhancement)
// ============================================================================

model Interview {
  id                       String    @id @default(uuid())
  workflowStageCandidateId String
  scheduledAt              DateTime
  duration                 Int // In minutes
  location                 String? // Physical location or meeting link
  meetingLink              String?
  interviewerIds           String[] // Array of User IDs
  status                   String    @default("SCHEDULED") // SCHEDULED, COMPLETED, CANCELLED, NO_SHOW
  notes                    String?   @db.Text
  isDeleted                Boolean           @default(false)
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt

  stageCandidate WorkflowStageCandidate @relation(fields: [workflowStageCandidateId], references: [id], onDelete: Cascade)

  @@index([workflowStageCandidateId])
  @@index([scheduledAt])
  @@schema("public")
}

// ============================================================================
// OPTIONAL: Offer Management (Future Enhancement)
// ============================================================================

model Offer {
  id                       String    @id @default(uuid())
  workflowStageCandidateId String    @unique
  position                 String
  salary                   Decimal   @db.Decimal(12, 2)
  currency                 String    @default("USD")
  startDate                DateTime?
  benefits                 String?   @db.Text
  terms                    String?   @db.Text
  isDeleted                Boolean           @default(false)
  status                   String    @default("DRAFT") // DRAFT, SENT, ACCEPTED, REJECTED, WITHDRAWN
  sentAt                   DateTime?
  respondedAt              DateTime?
  expiresAt                DateTime?
  createdAt                DateTime  @default(now())
  updatedAt                DateTime  @updatedAt

  stageCandidate WorkflowStageCandidate @relation(fields: [workflowStageCandidateId], references: [id], onDelete: Cascade)

  @@index([status])
  @@schema("public")
}
