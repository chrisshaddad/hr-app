// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  schemas  = ["public", "private"]
}

enum UserRole {
  SUPER_ADMIN // Manages all orgnaizations (can also accept org registrations)
  ORG_ADMIN // Manages a single organization (can also invite employees to their org)
  EMPLOYEE

  @@schema("public")
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY

  @@schema("public")
}

enum OrganizationStatus {
  PENDING // Awaiting super admin approval
  ACTIVE // Approved and operational
  REJECTED // Denied by super admin
  SUSPENDED
  INACTIVE

  @@schema("public")
}

model User {
  id          String   @id @default(uuid())
  email       String   @unique
  isConfirmed Boolean  @default(false)
  name        String
  role        UserRole @default(EMPLOYEE)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  password              Password?
  sessions              Session[]
  magicLinks            MagicLink[]
  createdOrganization   Organization?  @relation("OrganizationCreator")
  approvedOrganizations Organization[] @relation("OrganizationApprover")
  employee              Employee?
  tasks                 Task[]         @relation("TaskCreatedBy")

  @@schema("public")
}

model Password {
  id               String   @id @default(uuid())
  userId           String   @unique
  hashedPassword   String
  failedLoginCount Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@schema("private")
}

model Session {
  id        String   @id
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@schema("private")
}

model MagicLink {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique // securely generated random token, not a UUID
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@schema("private")
}

model Organization {
  id           String             @id @default(uuid())
  name         String
  status       OrganizationStatus @default(PENDING)
  description  String?            @db.Text
  website      String?
  createdById  String             @unique // User can only create one organization
  approvedById String?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  approvedAt   DateTime? // When super admin approved

  createdBy  User       @relation("OrganizationCreator", fields: [createdById], references: [id])
  approvedBy User?      @relation("OrganizationApprover", fields: [approvedById], references: [id])
  branches   Branch[]
  employees  Employee[]
  templates  Template[]

  @@index([approvedById])
  @@index([status])
  @@schema("public")
}

model Branch {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  street1        String?
  street2        String?
  city           String?
  state          String?
  postalCode     String?
  country        String
  phoneNumber    String?
  email          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  departments  Department[]
  employees    Employee[]

  @@index([organizationId])
  @@schema("public")
}

model Department {
  id          String   @id @default(uuid())
  branchId    String
  name        String
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  branch    Branch     @relation(fields: [branchId], references: [id], onDelete: Cascade)
  employees Employee[]

  @@index([branchId])
  @@schema("public")
}

enum EmployeeStatus {
  ACTIVE
  ON_BOARDING
  OFF_BOARDING
  ON_LEAVE
  PROBATION

  @@schema("public")
}

model EmployeePersonalInfo {
  id       String    @id @default(uuid())
  employee Employee?

  firstName String
  lastName  String
  email     String
  phone     String?

  // Profile fields from UserProfile
  dateOfBirth DateTime?
  gender      Gender?
  bio         String?   @db.Text

  // Address fields
  street1    String?
  street2    String?
  city       String?
  state      String?
  postalCode String?
  country    String?

  // Emergency contact
  emergencyContactName     String?
  emergencyContactPhone    String?
  emergencyContactRelation String?

  nationality       String?
  profilePictureUrl String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@schema("public")
}

model Employee {
  id String @id @default(uuid())

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id], onDelete: SetNull)

  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  lineManagerId String?
  lineManager   Employee?  @relation("EmployeeLineManager", fields: [lineManagerId], references: [id])
  // note: this is needed since Employee is both the parent and child in the relation, needed by prisma to differentiate the two sides of the relation
  directReports Employee[] @relation("EmployeeLineManager")

  // if the userId is null, it means the employee record is not yet linked to a user account
  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  jobTitle String
  joinDate DateTime
  timezone String
  status   EmployeeStatus

  personalInfoId String               @unique
  personalInfo   EmployeePersonalInfo @relation(fields: [personalInfoId], references: [id], onDelete: Cascade)

  checklists    Checklist[]
  tasks         Task[]
  assignedTasks Task[]      @relation("TaskAssignee")

  @@index([branchId])
  @@index([departmentId])
  @@schema("public")
}

enum TemplateType {
  ONBOARDING
  OFFBOARDING

  @@schema("public")
}

model Template {
  id          String       @id @default(uuid())
  type        TemplateType
  name        String
  description String?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  templateTasks TemplateTask[]
  checklists    Checklist[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@schema("public")
}

model Checklist {
  id String @id @default(uuid())

  templateId String
  template   Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  startDate   DateTime?
  dueDate     DateTime?
  completedAt DateTime?

  tasks Task[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([templateId])
  @@index([employeeId])
  @@schema("public")
}

enum TaskType {
  CHECKLIST
  UPLOAD
  EMPLOYEE_INFORMATION

  @@schema("public")
}

model TemplateTask {
  id         String   @id @default(uuid())
  templateId String
  template   Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  order       Int
  name        String
  taskType    TaskType
  description String?
  dueInDays   Int?

  tasks Task[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@schema("public")
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
  SKIPPED

  @@schema("public")
}

model Task {
  id String @id @default(uuid())

  checklistId String?
  checklist   Checklist? @relation(fields: [checklistId], references: [id], onDelete: Cascade)

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  assigneeId String?
  assignee   Employee? @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)

  templateTaskId String?
  templateTask   TemplateTask? @relation(fields: [templateTaskId], references: [id], onDelete: SetNull)

  order       Int
  name        String
  taskType    TaskType
  status      TaskStatus @default(TODO)
  dueDate     DateTime?
  description String?

  createdById String?
  createdBy   User?   @relation("TaskCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([checklistId])
  @@schema("public")
}
